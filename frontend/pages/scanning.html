<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyzing... | VERITAS</title>

    <!-- Favicon -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%230ea5e9' stroke-width='2'><path d='M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10'/><path d='m9 12 2 2 4-4'/></svg>">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="../css/styles.css">
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="navbar-brand">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="24" height="24">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10" />
                    <path d="m9 12 2 2 4-4" />
                </svg>
                <span>VERITAS</span>
            </div>
            <div class="status-badge">
                <span class="dot"></span>
                System Operational
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-container">
        <div class="analyzing-container">
            <div class="spinner-wrapper">
                <div class="spinner"></div>
                <div class="spinner-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" width="40" height="40">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10" />
                        <path d="m9 12 2 2 4-4" />
                    </svg>
                </div>
            </div>
            <h2 class="analyzing-title">Analyzing Integrity</h2>
            <div class="analysis-steps" id="analysisSteps"></div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="../js/icons.js"></script>
    <script src="../js/shared.js"></script>
    <script>
        const ScanningPage = {
            steps: [],
            currentStep: 0,
            stepInterval: null,

            async init() {
                const input = Veritas.getInput();
                if (!input) {
                    window.location.href = '../index.html';
                    return;
                }

                this.steps = this.getSteps(input.type, input.useSearch);
                this.renderSteps();
                this.startStepAnimation();

                try {
                    await this.runAnalysis(input);
                } catch (error) {
                    console.error('Analysis failed:', error);
                    window.location.href = '../index.html?error=' + encodeURIComponent(error.message);
                }
            },

            getSteps(type, useSearch) {
                const steps = ['Initializing forensic protocols...'];
                const typeSteps = {
                    text: ['Analyzing linguistic patterns...', 'Checking logical consistency...', 'Detecting LLM generation markers...'],
                    image: ['Scanning EXIF metadata...', 'Running Error Level Analysis...', 'Checking shadow coherence...', 'Detecting AI artifacts...'],
                    audio: ['Generating spectral analysis...', 'Detecting voice cloning...', 'Analyzing breathing patterns...'],
                    video: ['Extracting keyframes...', 'Checking audio-visual sync...', 'Analyzing temporal consistency...', 'Detecting face manipulation...']
                };
                steps.push(...(typeSteps[type] || []));
                if (useSearch) {
                    steps.push('Connecting to global index...', 'Cross-referencing sources...');
                } else {
                    steps.push('Skipping external search...');
                }
                steps.push('Compiling final verdict...');
                return steps;
            },

            renderSteps() {
                const container = document.getElementById('analysisSteps');
                container.innerHTML = this.steps.map((label, idx) => `
          <div class="step">
            <div class="step-indicator ${idx === 0 ? 'processing' : 'pending'}"></div>
            <span class="step-label ${idx === 0 ? 'processing' : ''}">${label}</span>
          </div>
        `).join('');
            },

            startStepAnimation() {
                this.stepInterval = setInterval(() => {
                    if (this.currentStep >= this.steps.length - 1) return;
                    const indicators = document.querySelectorAll('.step-indicator');
                    const labels = document.querySelectorAll('.step-label');

                    indicators[this.currentStep].classList.remove('processing');
                    indicators[this.currentStep].classList.add('completed');
                    indicators[this.currentStep].innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><polyline points="20 6 9 17 4 12"/></svg>`;
                    labels[this.currentStep].classList.remove('processing');
                    labels[this.currentStep].classList.add('completed');

                    this.currentStep++;
                    indicators[this.currentStep].classList.add('processing');
                    labels[this.currentStep].classList.add('processing');
                }, 1200);
            },

            async runAnalysis(input) {
                let content;
                let thumbnail = null;

                if (input.type === 'text') {
                    content = input.text;
                } else {
                    content = Veritas.dataURLtoFile(input.fileData, input.fileName);
                    thumbnail = await Veritas.generateThumbnail(content, input.type);
                }

                const result = await Veritas.verify(input.type, content, input.useSearch);
                clearInterval(this.stepInterval);

                document.querySelectorAll('.step-indicator').forEach(el => {
                    el.classList.remove('processing', 'pending');
                    el.classList.add('completed');
                    el.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><polyline points="20 6 9 17 4 12"/></svg>`;
                });
                document.querySelectorAll('.step-label').forEach(el => {
                    el.classList.remove('processing');
                    el.classList.add('completed');
                });

                Veritas.saveResult(result, thumbnail);
                Veritas.addToHistory({
                    type: input.type,
                    preview: input.type === 'text' ? (input.text.substring(0, 60) + (input.text.length > 60 ? '...' : '')) : input.fileName,
                    thumbnail,
                    result
                });
                Veritas.clearPending();

                await new Promise(r => setTimeout(r, 500));
                window.location.href = 'results.html';
            }
        };

        document.addEventListener('DOMContentLoaded', () => ScanningPage.init());
    </script>
</body>

</html>