<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Results | VERITAS</title>

    <!-- Favicon -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%230ea5e9' stroke-width='2'><path d='M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10'/><path d='m9 12 2 2 4-4'/></svg>">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="../css/styles.css">
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="navbar-brand">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" width="24" height="24">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10" />
                    <path d="m9 12 2 2 4-4" />
                </svg>
                <span>VERITAS</span>
            </div>
            <div class="status-badge">
                <span class="dot"></span>
                System Operational
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-container">
        <div class="results-container" id="resultsContainer"></div>
    </main>

    <!-- Scripts -->
    <script src="../js/icons.js"></script>
    <script src="../js/shared.js"></script>
    <script>
        const ResultsPage = {
            result: null,
            thumbnail: null,

            init() {
                const data = Veritas.getResult();
                if (!data || !data.result) {
                    window.location.href = '../index.html';
                    return;
                }
                this.result = data.result;
                this.thumbnail = data.thumbnail;
                this.render();
            },

            render() {
                const r = this.result;
                const isAuthentic = r.verdict === 'Authentic';
                const isSuspicious = r.verdict === 'Fake/Generated' || r.verdict === 'Suspicious';
                const verdictClass = isAuthentic ? 'authentic' : isSuspicious ? 'suspicious' : 'inconclusive';
                const gaugeColor = isAuthentic ? '#10b981' : isSuspicious ? '#ef4444' : '#f59e0b';

                let html = '';

                if (this.thumbnail) {
                    html += `
            <div class="evidence-preview">
              <div class="evidence-badge">
                ${Icons.image()}
                <span>Evidence</span>
              </div>
              <img src="${this.thumbnail}" alt="Evidence Preview" class="evidence-image">
            </div>
          `;
                }

                html += `
          <div class="verdict-banner ${verdictClass}">
            <div class="verdict-info">
              <div class="verdict-icon">
                ${isAuthentic ? Icons.shieldCheck() : Icons.alertTriangle()}
              </div>
              <div>
                <h2 class="verdict-label">Analysis Verdict</h2>
                <h1 class="verdict-text">${r.verdict}</h1>
              </div>
            </div>
            <div class="confidence-gauge">
              <div class="gauge-circle" style="--confidence: ${r.confidence}; --gauge-color: ${gaugeColor}">
                <div class="gauge-inner">
                  <span class="gauge-value">${r.confidence}%</span>
                  <span class="gauge-label">Trust</span>
                </div>
              </div>
            </div>
          </div>
        `;

                if (r.learnedPatternsUsed > 0) {
                    html += `
            <div class="learning-badge">
              <span class="learning-icon">ðŸ§ </span>
              <span>AI used <strong>${r.learnedPatternsUsed} learned patterns</strong></span>
            </div>
          `;
                }

                html += '<div class="results-grid">';

                html += `
          <div class="findings-column">
            <section class="section-card">
              <h3 class="section-title">Executive Summary</h3>
              <p class="summary-text">${r.summary || 'No summary available.'}</p>
            </section>
            <section class="section-card">
              <h3 class="section-title">Key Findings</h3>
              <ul class="findings-list">
                ${(r.reasoning || []).map(item => `<li>${item}</li>`).join('')}
              </ul>
            </section>
            ${this.renderRiskScore(r)}
            ${this.renderReverseSearch(r)}
          </div>
        `;

                html += `
          <div class="tech-column">
            <section class="section-card">
              <h3 class="section-title">Technical Analysis</h3>
              <div id="techDetails">
                ${this.renderTechDetails(r.technicalDetails || [])}
              </div>
            </section>
            ${this.renderSources(r)}
            <button class="btn-secondary" onclick="window.location.href='../index.html'">Start New Analysis</button>
          </div>
        `;

                html += '</div>';

                html += `
          <div class="feedback-section" id="feedbackSection">
            <button class="btn-report" onclick="ResultsPage.showFeedbackForm()">
              ${Icons.alertTriangle()}
              Report Incorrect Verdict
            </button>
          </div>
        `;

                document.getElementById('resultsContainer').innerHTML = html;
            },

            renderRiskScore(r) {
                if (r.riskScore === undefined) return '';
                const risk = r.riskScore;
                const level = risk > 70 ? 'high' : risk > 40 ? 'medium' : 'low';
                const label = risk > 70 ? 'HIGH RISK' : risk > 40 ? 'MODERATE' : 'LOW RISK';
                const color = risk > 70 ? '#ef4444' : risk > 40 ? '#f59e0b' : '#10b981';
                return `
          <section class="section-card">
            <h3 class="section-title">Manipulation Risk Score</h3>
            <div class="risk-container">
              <div class="risk-bar-bg">
                <div class="risk-bar-fill" style="width: ${risk}%; background: ${color}"></div>
              </div>
              <div class="risk-info">
                <span class="risk-value" style="color: ${color}">${risk}%</span>
                <span class="risk-label ${level}">${label}</span>
              </div>
            </div>
          </section>
        `;
            },

            renderReverseSearch(r) {
                if (!r.reverseSearch) return '';
                const rev = r.reverseSearch;
                return `
          <section class="section-card">
            <h3 class="section-title">Reverse Image Search</h3>
            <div class="reverse-search-info">
              <div class="matches-count">
                <span class="count">${rev.matches || 0}</span>
                <span class="label">matches found</span>
              </div>
            </div>
          </section>
        `;
            },

            renderTechDetails(details) {
                return details.map((item) => `
          <div class="tech-detail">
            <div class="tech-header">
              <div class="tech-info">
                <span class="tech-label">${item.label}</span>
                <div class="tech-value">${item.value}</div>
              </div>
              <span class="status-badge-sm ${item.status}">${item.status}</span>
            </div>
          </div>
        `).join('');
            },

            renderSources(r) {
                if (!r.sources || r.sources.length === 0) return '';
                return `
          <section class="section-card">
            <h3 class="section-title">Verified Sources</h3>
            <ul class="sources-list">
              ${r.sources.map(s => `<li><a href="${s.uri}" target="_blank">${s.title || s.uri}</a></li>`).join('')}
            </ul>
          </section>
        `;
            },

            showFeedbackForm() {
                document.getElementById('feedbackSection').innerHTML = `
          <div class="feedback-form">
            <h4>${Icons.shieldCheck()} Teach Veritas</h4>
            <p>What should the correct verdict be?</p>
            <div class="verdict-buttons">
              <button class="verdict-btn" onclick="ResultsPage.submitFeedback('Authentic')">Actually Real</button>
              <button class="verdict-btn" onclick="ResultsPage.submitFeedback('Fake/Generated')">Actually Fake</button>
            </div>
            <button class="btn-cancel" onclick="ResultsPage.cancelFeedback()">Cancel</button>
          </div>
        `;
            },

            cancelFeedback() {
                document.getElementById('feedbackSection').innerHTML = `
          <button class="btn-report" onclick="ResultsPage.showFeedbackForm()">
            ${Icons.alertTriangle()}
            Report Incorrect Verdict
          </button>
        `;
            },

            async submitFeedback(correctVerdict) {
                try {
                    await fetch('http://localhost:5000/api/learn', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: 'image',
                            pattern: `Verdict corrected to ${correctVerdict}`,
                            verdict: correctVerdict,
                            confidence: 70,
                            originalVerdict: this.result.verdict
                        })
                    });
                    document.getElementById('feedbackSection').innerHTML = `
            <div class="feedback-success">
              <h4>Thanks for the feedback!</h4>
              <p>Your correction has been recorded.</p>
            </div>
          `;
                } catch (e) {
                    document.getElementById('feedbackSection').innerHTML = `
            <div class="feedback-success">
              <h4>Feedback Saved</h4>
              <p>Stored locally.</p>
            </div>
          `;
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => ResultsPage.init());
    </script>
</body>

</html>